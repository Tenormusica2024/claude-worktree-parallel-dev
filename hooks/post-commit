#!/bin/bash

set -e

HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$HOOK_DIR")"

COLOR_RESET="\033[0m"
COLOR_GREEN="\033[0;32m"
COLOR_YELLOW="\033[0;33m"
COLOR_BLUE="\033[0;34m"

log_info() {
    echo -e "${COLOR_BLUE}ğŸ“ [post-commit] $1${COLOR_RESET}"
}

log_success() {
    echo -e "${COLOR_GREEN}âœ… [post-commit] $1${COLOR_RESET}"
}

log_info "ã‚³ãƒŸãƒƒãƒˆå¾Œå‡¦ç†ã‚’é–‹å§‹..."

BRANCH_NAME=$(git symbolic-ref --short HEAD 2>/dev/null || echo "detached")
COMMIT_HASH=$(git rev-parse --short HEAD)
COMMIT_MESSAGE=$(git log -1 --pretty=%B)

log_info "ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH_NAME"
log_info "ã‚³ãƒŸãƒƒãƒˆ: $COMMIT_HASH"

if [[ "$BRANCH_NAME" =~ ^feature/ ]]; then
    log_info "feature ãƒ–ãƒ©ãƒ³ãƒã‚’æ¤œå‡º"
    
    FEATURE_NAME=$(echo "$BRANCH_NAME" | sed 's/^feature\///')
    
    log_info "è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã—ã¾ã™ã‹? (y/n)"
    read -t 10 -r answer || answer="n"
    
    if [ "$answer" = "y" ] || [ "$answer" = "Y" ]; then
        log_info "Claude Codeã§ãƒ¬ãƒ“ãƒ¥ãƒ¼worktreeã‚’é–‹ã„ã¦ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
        echo ""
        echo "Task("
        echo "    subagent_type=\"code-reviewer\","
        echo "    prompt=\"feature/$FEATURE_NAME ãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ ($COMMIT_HASH) ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„\""
        echo ")"
        echo ""
    fi
fi

if [ -f "$PROJECT_ROOT/../github-remote-desktop/task_complete_private.py" ]; then
    log_info "GitHub Issueã«è‡ªå‹•å ±å‘Šã—ã¾ã™ã‹? (y/n)"
    read -t 10 -r answer || answer="n"
    
    if [ "$answer" = "y" ] || [ "$answer" = "Y" ]; then
        REPORT_MESSAGE="ã‚³ãƒŸãƒƒãƒˆå®Œäº†: $COMMIT_HASH

ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH_NAME
ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:
$COMMIT_MESSAGE"
        
        cd "$PROJECT_ROOT/../github-remote-desktop"
        python task_complete_private.py "$REPORT_MESSAGE"
        
        log_success "GitHub Issueã«å ±å‘Šå®Œäº†"
    fi
fi

log_success "post-commitå‡¦ç†å®Œäº†"
exit 0

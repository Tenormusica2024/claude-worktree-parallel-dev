#!/bin/bash

set -e

HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$HOOK_DIR")"

COLOR_RESET="\033[0m"
COLOR_GREEN="\033[0;32m"
COLOR_YELLOW="\033[0;33m"
COLOR_RED="\033[0;31m"
COLOR_BLUE="\033[0;34m"

log_info() {
    echo -e "${COLOR_BLUE}ğŸš€ [pre-push] $1${COLOR_RESET}"
}

log_success() {
    echo -e "${COLOR_GREEN}âœ… [pre-push] $1${COLOR_RESET}"
}

log_warning() {
    echo -e "${COLOR_YELLOW}âš ï¸  [pre-push] $1${COLOR_RESET}"
}

log_error() {
    echo -e "${COLOR_RED}âŒ [pre-push] $1${COLOR_RESET}"
}

log_info "ãƒ—ãƒƒã‚·ãƒ¥å‰ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹..."

BRANCH_NAME=$(git symbolic-ref --short HEAD 2>/dev/null || echo "detached")

log_info "ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH_NAME"

REVIEW_REPORTS=$(find "$PROJECT_ROOT/review-reports" -name "review-*.md" -mtime -1 2>/dev/null || true)

if [ -z "$REVIEW_REPORTS" ]; then
    log_warning "æœ€è¿‘ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    log_info "ãƒ—ãƒƒã‚·ãƒ¥å‰ã«ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™"
    
    log_warning "ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã—ã§ãƒ—ãƒƒã‚·ãƒ¥ã‚’ç¶šè¡Œã—ã¾ã™ã‹? (y/n)"
    read -t 10 -r answer || answer="n"
    
    if [ "$answer" != "y" ] && [ "$answer" != "Y" ]; then
        log_error "ãƒ—ãƒƒã‚·ãƒ¥ã‚’ä¸­æ­¢ã—ã¾ã™"
        log_info "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
        echo ""
        echo "./scripts/parallel-dev-flow.sh review $(echo "$BRANCH_NAME" | sed 's/^feature\///')"
        echo ""
        exit 1
    fi
else
    log_info "æœ€æ–°ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ:"
    echo "$REVIEW_REPORTS" | sed 's/^/  - /'
    
    CRITICAL_REPORTS=$(grep -l "âŒ NOT APPROVED" $REVIEW_REPORTS 2>/dev/null || true)
    
    if [ -n "$CRITICAL_REPORTS" ]; then
        log_error "æœªæ‰¿èªã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™:"
        echo "$CRITICAL_REPORTS" | sed 's/^/  - /'
        
        log_warning "Criticalå•é¡Œã‚’ä¿®æ­£ã›ãšã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã™ã‹? (y/n)"
        read -t 10 -r answer || answer="n"
        
        if [ "$answer" != "y" ] && [ "$answer" != "Y" ]; then
            log_error "ãƒ—ãƒƒã‚·ãƒ¥ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚å•é¡Œã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚"
            exit 1
        fi
    else
        log_success "ã™ã¹ã¦ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæ‰¿èªã•ã‚Œã¦ã„ã¾ã™"
    fi
fi

if [[ "$BRANCH_NAME" =~ ^feature/ ]]; then
    log_info "UIæ¤œè¨¼ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã‹? (y/n/skip)"
    read -t 10 -r answer || answer="skip"
    
    if [ "$answer" = "n" ] || [ "$answer" = "N" ]; then
        log_warning "UIæ¤œè¨¼ã‚’æ¨å¥¨ã—ã¾ã™"
        log_info "ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§UIæ¤œè¨¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
        echo ""
        echo "./scripts/parallel-dev-flow.sh ui-test $(echo "$BRANCH_NAME" | sed 's/^feature\///') https://your-app-url.com"
        echo ""
    fi
fi

log_success "pre-pushãƒã‚§ãƒƒã‚¯å®Œäº†"
exit 0
